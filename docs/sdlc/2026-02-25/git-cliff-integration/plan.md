# git-cliff 集成实现计划

## 方案说明

为 claudex 项目配置 git-cliff，实现：
1. 本地 `git cliff` 命令预览 changelog
2. GitHub Actions release workflow 自动生成 release notes（替换 `--generate-notes`）
3. 支持项目特有的 `type[scope]: 中文描述` commit 格式

---

## 改动文件

### 1. `cliff.toml`（新建）

项目根目录创建 git-cliff 配置文件。

```toml
# git-cliff ~ configuration file
# https://git-cliff.org/docs/configuration

[remote.github]
owner = "StringKe"
repo = "claudex"

[changelog]
# 全局 CHANGELOG.md 的 header
header = """
# Changelog\n
本文件记录 claudex 的所有重要变更。\n
"""

# 每个 release 的 body 模板
body = """
{%- macro remote_url() -%}
  https://github.com/{{ remote.github.owner }}/{{ remote.github.repo }}
{%- endmacro -%}

{% if version -%}
  ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
  ## [未发布]
{% endif -%}

{% for group, commits in commits | group_by(attribute="group") %}
  ### {{ group | striptags | trim }}
  {% for commit in commits %}
    - {% if commit.scope %}**{{ commit.scope }}**: {% endif %}\
      {{ commit.message | split(pat="\\n") | first | trim }}\
      {% if commit.remote.username %} by @{{ commit.remote.username }}{%- endif %}\
      {% if commit.remote.pr_number %} in \
        [#{{ commit.remote.pr_number }}]({{ self::remote_url() }}/pull/{{ commit.remote.pr_number }})\
      {%- endif -%}
  {%- endfor %}
{% endfor -%}

{%- if github -%}
{% if github.contributors | filter(attribute="is_first_time", value=true) | length != 0 %}

  ### 新贡献者
  {%- for contributor in github.contributors | filter(attribute="is_first_time", value=true) %}
    * @{{ contributor.username }} 首次贡献\
      {%- if contributor.pr_number %} \
        [#{{ contributor.pr_number }}]({{ self::remote_url() }}/pull/{{ contributor.pr_number }})\
      {%- endif %}
  {%- endfor %}
{%- endif -%}
{%- endif %}
"""

footer = """
<!-- generated by git-cliff -->
"""

trim = true

postprocessors = [
  # 将 issue/PR 编号转为链接
  { pattern = '#([0-9]+)', replace = "[#${1}](https://github.com/StringKe/claudex/issues/${1})" },
]

[git]
# 启用 conventional commit 解析
conventional_commits = true
# 保留非 conventional commit（不过滤）
filter_unconventional = false
# 保护 breaking change 不被跳过
protect_breaking_commits = true
split_commits = false
filter_commits = false
topo_order = false
sort_commits = "oldest"
tag_pattern = "v[0-9].*"

# 预处理器：将 type[scope]: 转换为 type(scope): 以兼容 conventional commit 解析
commit_preprocessors = [
  # type[scope]: desc -> type(scope): desc
  { pattern = '^([a-z]+)\[([^\]]+)\]', replace = '${1}(${2})' },
  # 移除 issue 编号（会在 postprocessors 中重新链接）
  { pattern = '\((\w+\s)?#([0-9]+)\)', replace = "" },
]

# commit 分类解析器
commit_parsers = [
  { message = "^feat", group = "<!-- 0 -->新功能" },
  { message = "^fix", group = "<!-- 1 -->Bug 修复" },
  { message = "^perf", group = "<!-- 2 -->性能优化" },
  { message = "^refactor", group = "<!-- 3 -->重构" },
  { message = "^docs", group = "<!-- 4 -->文档" },
  { message = "^test", group = "<!-- 5 -->测试" },
  { message = "^build", group = "<!-- 6 -->构建" },
  { message = "^ci", group = "<!-- 7 -->CI/CD" },
  { message = "^chore", group = "<!-- 8 -->杂项" },
  # 跳过 merge commit
  { message = "^Merge", skip = true },
]
```

**设计决策说明：**

- **`commit_preprocessors`**：将 `feat[proxy]` 转换为 `feat(proxy)` 后，`conventional_commits = true` 可以原生解析 type/scope/description，无需在模板中手动提取
- **`filter_unconventional = false`**：保留不符合格式的 commit（如 merge commit 通过 skip 处理）
- **分组排序**：使用 `<!-- N -->` HTML 注释前缀控制分组顺序（git-cliff 按字符串排序，注释在 `striptags` 过滤器中被去除）
- **中文组名**：新功能/Bug 修复/重构等，契合项目中文 commit 风格
- **postprocessors**：自动将 `#123` 转为 GitHub issue 链接

### 2. `.github/workflows/release.yml`（修改）

改造 `create-release` job，用 git-cliff 替换 `--generate-notes`：

```yaml
name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 关键：git-cliff 需要完整历史

      - name: Get tag
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: git-cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header --github-repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OUTPUT: CHANGES.md

      - name: Create draft release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.tag.outputs.tag }}
          BODY: ${{ steps.git-cliff.outputs.content }}
        run: gh release create "$TAG" --draft --title "$TAG" --notes "$BODY"

  build:
    name: Build ${{ matrix.target }}
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          - target: x86_64-apple-darwin
            os: macos-14
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev libsecret-1-dev
          if [ "${{ matrix.target }}" = "x86_64-unknown-linux-musl" ]; then
            sudo apt-get install -y musl-tools
          fi

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Package
        env:
          TAG: ${{ needs.create-release.outputs.tag }}
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../claudex-${TAG}-${{ matrix.target }}.tar.gz claudex

      - name: Upload
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.create-release.outputs.tag }}
        run: gh release upload "$TAG" claudex-${TAG}-${{ matrix.target }}.tar.gz

  publish-release:
    name: Publish Release
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.create-release.outputs.tag }}
        run: gh release edit "$TAG" --draft=false
```

**关键变更：**
1. `actions/checkout` 添加 `fetch-depth: 0`（git-cliff 需要完整 git 历史）
2. 新增 `Generate changelog` step，使用 `orhun/git-cliff-action@v4`
3. `--latest`：只生成当前 tag 到上一个 tag 的变更
4. `--strip header`：去掉全局 header（release notes 不需要 "# Changelog" 标题）
5. `--github-repo ${{ github.repository }}`：动态传入仓库名
6. `gh release create` 改为 `--notes "$BODY"` 替代 `--generate-notes`

---

## 考量与权衡

### 为什么选择方案 B（预处理器 + conventional_commits）

| 维度 | 方案 A（纯正则） | 方案 B（预处理器转换） |
|------|-----------------|---------------------|
| scope 解析 | 需手动在 commit_parsers 中提取 | conventional_commits 自动解析 |
| breaking change | 需手动匹配 `!` | 自动识别 |
| 模板中 commit.scope | 不可用 | 可用 |
| 维护成本 | 高（每个 type 都要完整正则） | 低（一条预处理规则） |
| 兼容性 | 独立于格式规范 | 依赖 conventional commit 规范 |

### postprocessors 中 issue 链接的处理

将 `#123` 自动转为链接。注意：
- `commit_preprocessors` 先移除 `(#123)` 格式（避免重复链接）
- `postprocessors` 在最终 changelog 中将裸 `#123` 转为超链接
- 这确保了不论 commit 中写 `(#123)` 还是 `#123`，最终都能正确链接

### GitHub Action 版本选择

使用 `orhun/git-cliff-action@v4` tag 引用而非 SHA pin：
- 优点：自动获取 v4 大版本内的修复
- 如果安全要求更高，可改为 SHA pin（如 `@104a6cf`）

---

## 本地使用

开发者安装 git-cliff 后可在本地预览：

```bash
# 安装（macOS）
brew install git-cliff

# 安装（cargo）
cargo install git-cliff

# 预览完整 changelog
git cliff

# 预览最新版本的变更
git cliff --latest

# 预览未发布的变更
git cliff --unreleased

# 输出到文件
git cliff -o CHANGELOG.md
```

---

## Todo List

### Phase 1: 配置文件
- [ ] 创建 `cliff.toml` 配置文件
- [ ] 本地验证：运行 `git cliff` 确认输出格式正确

### Phase 2: GitHub Actions
- [ ] 修改 `.github/workflows/release.yml`
- [ ] 验证 workflow YAML 语法

### Phase 3: 验证
- [ ] 本地运行 `git cliff --latest` 查看效果
- [ ] 本地运行 `git cliff` 生成完整 changelog 查看效果
