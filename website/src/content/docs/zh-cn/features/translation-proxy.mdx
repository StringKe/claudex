---
title: 翻译代理
description: 自动 Anthropic-to-OpenAI 协议翻译
---

import { Aside } from '@astrojs/starlight/components';

翻译代理是 Claudex 的核心。它位于 Claude Code 和 AI 提供商之间，透明地在 Anthropic Messages API 和 OpenAI Chat Completions API 之间进行转换。

## 工作原理

```
Claude Code → Anthropic Messages API 请求
    │
    └── Claudex 代理 (127.0.0.1:13456)
        │
        ├── DirectAnthropic 提供商 → 替换 header 直接转发
        │
        ├── OpenAICompatible 提供商
        │   ├── 翻译请求：Anthropic → OpenAI Chat Completions
        │   ├── 转发到提供商
        │   └── 翻译响应：OpenAI → Anthropic
        │
        └── OpenAIResponses 提供商
            ├── 翻译请求：Anthropic → OpenAI Responses API
            ├── 转发到提供商
            └── 翻译响应：Responses → Anthropic
```

## 翻译内容

### 请求翻译（Anthropic → OpenAI）

| Anthropic | OpenAI |
|-----------|--------|
| `system` 字段 | `messages` 数组中的 system message |
| `messages[].content` 块（text、image、tool_use） | `messages[].content` + `tool_calls` |
| `tools` 数组（JSON Schema） | `tools` 数组（function 格式） |
| `tool_choice` | `tool_choice` |
| `max_tokens` | `max_tokens` |
| `temperature`、`top_p` | 直接映射 |

### 响应翻译（OpenAI → Anthropic）

| OpenAI | Anthropic |
|--------|-----------|
| `choices[0].message.content` | `content` 块 |
| `choices[0].message.tool_calls` | `tool_use` 内容块 |
| `finish_reason: stop` | `stop_reason: end_turn` |
| `finish_reason: tool_calls` | `stop_reason: tool_use` |
| `usage.prompt_tokens` / `completion_tokens` | `usage.input_tokens` / `output_tokens` |

## 流式翻译

Claudex 完全支持 SSE（Server-Sent Events）流式传输，将 OpenAI 流块实时翻译为 Anthropic 流事件：

| OpenAI SSE | Anthropic SSE |
|------------|---------------|
| 首个 chunk | `message_start` + `content_block_start` |
| `choices[0].delta.content` | `content_block_delta`（text_delta） |
| `choices[0].delta.tool_calls` | `content_block_delta`（input_json_delta） |
| `finish_reason` 出现 | `content_block_stop` + `message_delta` + `message_stop` |

流式翻译器维护一个状态机，正确处理 tool call 的累积和内容块边界。

## 支持的提供商

| 提供商 | 类型 | Base URL |
|--------|------|----------|
| Anthropic | DirectAnthropic | `https://api.anthropic.com` |
| MiniMax | DirectAnthropic | `https://api.minimax.io/anthropic` |
| OpenRouter | OpenAICompatible | `https://openrouter.ai/api/v1` |
| Grok (xAI) | OpenAICompatible | `https://api.x.ai/v1` |
| OpenAI | OpenAICompatible | `https://api.openai.com/v1` |
| DeepSeek | OpenAICompatible | `https://api.deepseek.com` |
| Kimi/Moonshot | OpenAICompatible | `https://api.moonshot.cn/v1` |
| GLM（智谱） | OpenAICompatible | `https://open.bigmodel.cn/api/paas/v4` |
| Ollama | OpenAICompatible | `http://localhost:11434/v1` |
| vLLM | OpenAICompatible | `http://localhost:8000/v1` |
| ChatGPT/Codex 订阅 | OpenAIResponses | `https://chatgpt.com/backend-api/codex` |

<Aside type="tip">
  DirectAnthropic 提供商无需翻译。OpenAIResponses 提供商使用 Responses API（`/responses` 端点），区别于 Chat Completions（`/chat/completions`）。
</Aside>

## 代理管理

```bash
# 以守护进程方式启动代理
claudex proxy start -d

# 查看代理状态
claudex proxy status

# 停止代理守护进程
claudex proxy stop

# 使用自定义端口
claudex proxy start -p 8080
```

运行 `claudex run <profile>` 时，如果代理未运行，会自动在后台启动。
