---
title: 設定
description: Claudex のプロファイルと設定の構成方法
---

import { Aside } from '@astrojs/starlight/components';

## 設定ファイルの検索順序

Claudex は以下の順序で設定ファイルを検索します:

1. `$CLAUDEX_CONFIG` 環境変数
2. `./claudex.toml` (カレントディレクトリ)
3. `./.claudex/config.toml` (カレントディレクトリ)
4. 親ディレクトリ (最大10階層)、両方のパターンを確認
5. `~/.config/claudex/config.toml` (XDG — プラットフォーム固有のパスより**先に**確認)

<Aside type="note">
  XDG パス (`~/.config/claudex/config.toml`) はプラットフォーム固有のパスより先に確認されるようになりました。設定ファイルが存在しない場合、デフォルト設定の作成時に XDG パスが使用されます。
</Aside>

```bash
# 読み込まれた設定ファイルのパスと検索順序を表示
claudex config

# カレントディレクトリにローカル設定を作成
claudex config --init
```

<Aside type="tip">
  プロジェクトレベルの設定 (`./claudex.toml`) はグローバル設定より優先されるため、プロジェクトごとにプロバイダーをカスタマイズできます。
</Aside>

## グローバル設定

```toml
# claude バイナリのパス (デフォルト: PATH から "claude")
# claude_binary = "/usr/local/bin/claude"

# プロキシ設定
proxy_port = 13456
proxy_host = "127.0.0.1"

# ログレベル: trace, debug, info, warn, error
log_level = "info"

# モデルエイリアス (短縮名 → 完全なモデル名)
[model_aliases]
grok3 = "grok-3-beta"
gpt4o = "gpt-4o"
ds3 = "deepseek-chat"
```

## プロファイル

各プロファイルは AI プロバイダー接続を表します。プロバイダータイプは3種類あります:

### DirectAnthropic

Anthropic Messages API をネイティブにサポートするプロバイダー向けです。リクエストは最小限の変更でそのまま転送されます。

```toml
[[profiles]]
name = "anthropic"
provider_type = "DirectAnthropic"
base_url = "https://api.anthropic.com"
api_key = "sk-ant-..."
default_model = "claude-sonnet-4-20250514"
priority = 100
enabled = true
```

対応プロバイダー: **Anthropic**、**MiniMax**

### OpenAICompatible

OpenAI Chat Completions API を使用するプロバイダー向けです。Claudex が Anthropic と OpenAI のプロトコル間を自動翻訳します。

```toml
[[profiles]]
name = "grok"
provider_type = "OpenAICompatible"
base_url = "https://api.x.ai/v1"
api_key = "xai-..."
default_model = "grok-3-beta"
backup_providers = ["deepseek"]
priority = 100
enabled = true
```

対応プロバイダー: **Grok (xAI)**、**OpenAI**、**DeepSeek**、**Kimi/Moonshot**、**GLM (Zhipu)**、**OpenRouter**、**Ollama**、**vLLM**、**LM Studio**

### OpenAIResponses

OpenAI Responses API を使用するプロバイダー向けです (例: ChatGPT/Codex サブスクリプション)。Claudex が Anthropic Messages API と OpenAI Responses API 間を翻訳します。

```toml
[[profiles]]
name = "codex-sub"
provider_type = "OpenAIResponses"
base_url = "https://chatgpt.com/backend-api/codex"
default_model = "gpt-4o"
auth_type = "oauth"
oauth_provider = "openai"
```

対応プロバイダー: **ChatGPT/Codex サブスクリプション** (Codex CLI 経由)

<Aside type="tip">
  このプロバイダータイプは主に OAuth サブスクリプションで使用されます。Codex CLI のセットアップ手順の詳細は [プロバイダーセットアップガイド](/ja/guides/provider-setup/) を参照してください。
</Aside>

### プロファイルフィールド

| フィールド | デフォルト | 説明 |
|------------|------------|------|
| `name` | *必須* | ユニークなプロファイル識別子 |
| `provider_type` | `DirectAnthropic` | `DirectAnthropic`、`OpenAICompatible`、または `OpenAIResponses` |
| `base_url` | *必須* | プロバイダー API エンドポイント |
| `api_key` | `""` | API キー (平文) |
| `api_key_keyring` | — | OS キーチェーンから API キーを読み取る |
| `default_model` | *必須* | 使用するデフォルトモデル |
| `auth_type` | `"api-key"` | `"api-key"` または `"oauth"` |
| `oauth_provider` | — | OAuth プロバイダー (`claude`、`openai`、`google`、`qwen`、`kimi`、`github`)。`auth_type = "oauth"` の場合に必須 |
| `backup_providers` | `[]` | フェイルオーバー用プロファイル名 |
| `custom_headers` | `{}` | 追加 HTTP ヘッダー |
| `extra_env` | `{}` | Claude 用の追加環境変数 |
| `priority` | `100` | スマートルーティングの優先度 |
| `enabled` | `true` | このプロファイルが有効かどうか |
| `[profiles.models]` | — | モデルスロットマッピングテーブル (`haiku`、`sonnet`、`opus` フィールド) |

### インタラクティブセットアップ

プロファイルを追加する最も簡単な方法はインタラクティブウィザードです:

```bash
claudex profile add
```

プロバイダーの選択、API キーの入力 (キーリングへの保存オプション付き)、モデルの選択、接続テストをガイドしてくれます。

## キーリング連携

平文の設定ファイルではなく OS キーチェーンに API キーを安全に保存できます:

```toml
[[profiles]]
name = "grok"
api_key_keyring = "grok-api-key"   # OS キーチェーンから読み取る
```

対応バックエンド:
- **macOS**: Keychain
- **Linux**: Secret Service (GNOME Keyring / KDE Wallet)

## OAuth サブスクリプション認証

API キーの代わりに、OAuth を通じて既存のプロバイダーサブスクリプションで認証できます。Claude Pro/Team、ChatGPT Plus などのサブスクリプションプランをお持ちの場合に便利です。

### セットアップ

1. プロファイルの `auth_type` を `"oauth"` に設定し、`oauth_provider` を指定します:

```toml
[[profiles]]
name = "chatgpt-oauth"
provider_type = "OpenAICompatible"
base_url = "https://api.openai.com/v1"
default_model = "gpt-4o"
auth_type = "oauth"
oauth_provider = "openai"
```

2. `auth` コマンドでログインします:

```bash
claudex auth login openai
```

3. 認証状態を確認します:

```bash
claudex auth status
```

### 対応プロバイダー

| プロバイダー | `oauth_provider` | トークンソース |
|--------------|-----------------|----------------|
| Claude | `claude` | `~/.claude` から読み取り (Claude Code のネイティブ設定) |
| OpenAI | `openai` | `~/.codex/auth.json` から読み取り (Codex CLI) |
| Google | `google` | OAuth デバイスコードフロー |
| Qwen | `qwen` | OAuth デバイスコードフロー |
| Kimi | `kimi` | OAuth デバイスコードフロー |
| GitHub | `github` | OAuth デバイスコードフロー |

<Aside type="tip">
  **OpenAI** の場合、[Codex CLI](https://github.com/openai/codex) をインストールしてログイン済み (`codex auth`) であることを確認してください。Claudex は `~/.codex/auth.json` からトークンを自動的に読み取ります。プロファイルは Responses API 経由で通信するため `provider_type = "OpenAIResponses"` を使用してください。
</Aside>

<Aside type="tip">
  **Claude** の場合、Claudex は `~/.claude` から既存の Claude Code OAuth セッションを読み取ります。Claude Code にすでにログインしていれば、別途ログインする手順は不要です。
</Aside>

### ゲートウェイ認証モード

OAuth プロファイルを使用する場合、Claudex は Claude Code を起動する際に `ANTHROPIC_API_KEY` ではなく `ANTHROPIC_AUTH_TOKEN` を設定します。これにより、内部で `ANTHROPIC_API_KEY` を使用する Claude Code 自身のサブスクリプションログインメカニズムとの競合を防ぎます。

プロキシは OAuth トークンの有効期限が切れる前に自動的に更新します。以下のコマンドで手動で更新することもできます:

```bash
claudex auth refresh openai
```

## モデルスロットマッピング

Claude Code には **haiku**、**sonnet**、**opus** の3つのスロットを持つ組み込み `/model` スイッチャーがあります。デフォルトでは Anthropic モデルにマッピングされますが、Claudex を使用することでどのプロバイダーのモデルにもマッピングできます。

### 設定

任意のプロファイルに `[profiles.models]` テーブルを追加します:

```toml
[[profiles]]
name = "grok"
provider_type = "OpenAICompatible"
base_url = "https://api.x.ai/v1"
api_key = "xai-..."
default_model = "grok-3-beta"

[profiles.models]
haiku = "grok-3-mini-beta"
sonnet = "grok-3-beta"
opus = "grok-3-beta"
```

Claude Code 内で `/model sonnet` と入力すると、Claudex はリクエストを `grok-3-beta` を使用するように変換します。`/model opus` コマンドも `grok-3-beta` にマッピングされます。

### 主要プロバイダーの設定例

```toml
# OpenAI モデルマッピング
[profiles.models]
haiku = "gpt-4o-mini"
sonnet = "gpt-4o"
opus = "o1"

# DeepSeek モデルマッピング
[profiles.models]
haiku = "deepseek-chat"
sonnet = "deepseek-chat"
opus = "deepseek-reasoner"

# Google Gemini モデルマッピング
[profiles.models]
haiku = "gemini-2.0-flash"
sonnet = "gemini-2.5-pro"
opus = "gemini-2.5-pro"
```

<Aside type="note">
  モデルスロットが設定されていない場合、プロファイルの `default_model` がフォールバックとして使用されます。
</Aside>

## ツール名の互換性

一部のプロバイダー (特に OpenAI) はツール (ファンクション) 名に64文字の制限を設けています。Claude Code はこの制限を超えるツール名を生成することがあります。

Claudex は OpenAI 互換プロバイダーにリクエストを送信する際に64文字を超えるツール名を自動的に短縮し、レスポンス処理時に元の名前を透過的に復元します。このラウンドトリップは完全に透過的で、設定は不要です。

## 非インタラクティブモード

Claudex は CI/CD パイプライン、スクリプト、自動化での使用のためにワンショット (非インタラクティブ) 実行をサポートしています:

```bash
# レスポンスを出力して終了
claudex run grok "Explain this codebase" --print

# すべての許可プロンプトをスキップ (完全自動化パイプライン向け)
claudex run grok "Fix lint errors" --print --dangerously-skip-permissions
```

<Aside type="caution">
  `--dangerously-skip-permissions` はすべての安全プロンプトを無効化します。信頼できる自動化環境でのみ使用してください。
</Aside>

非インタラクティブモードでは、ログは stderr ではなく `~/Library/Caches/claudex/proxy-{timestamp}-{pid}.log` のインスタンスごとのログファイルに書き込まれ、パイプと自動化のために標準出力をクリーンに保ちます。

## インスタンスごとのログファイル

各 Claudex プロキシインスタンスは独自のファイルにログを書き込みます:

```
~/Library/Caches/claudex/proxy-{timestamp}-{pid}.log
```

これにより、複数インスタンスを実行する際のログの混在を防ぎ、`claudex run` 中 (特に非インタラクティブモード時) に stderr をクリーンに保ちます。ログにはプロキシの起動、リクエスト変換、OAuth トークン更新イベント、サーキットブレーカーの状態変化が含まれます。

## 完全な設定例

すべてのプロバイダーとオプションを含む完全な設定ファイルは [`config.example.toml`](https://github.com/StringKe/claudex/blob/main/config.example.toml) を参照してください。

各プロバイダーのステップバイステップのセットアップ手順 (API キーのリンクや OAuth フローを含む) は [プロバイダーセットアップガイド](/ja/guides/provider-setup/) を参照してください。
